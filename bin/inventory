#!/usr/bin/ruby
$: << File.join(File.dirname(__FILE__), "..", "lib")

configdir = File.join(File.dirname(__FILE__), "../lib/config")
target_dir = File.join(File.dirname(__FILE__), "../target")

if Process.uid != 0
  raise 'FATAL: Process needs to run as root!'
end

require 'optparse'
require 'provision'
require 'provision/inventory'
require 'provision/workqueue'

extend Provision::Inventory
require 'home/inventory/kvmc7'

host = nil
env = nil
generator = nil

@option_parser = OptionParser.new do|opts|
  opts.banner = "Usage: provision --host"
  opts.on("-h","--host HOST", "host") do |h|
    host = h
  end
  opts.on("-e","--env ENV", "env") do |e|
    env = e
  end
  opts.on("-g","--generator GENERATOR", "generator") do |g|
    generator = g
  end
end
@option_parser.parse!

if (host == nil)
  print  @option_parser.help()
  exit
end

require 'yaml'

work_queue = Provision.work_queue(:worker_count=>4)

get_host(host).get_env(env).get_generator(generator).generate_specs.each do |spec|
  print spec.to_yaml
  work_queue.add(spec)
end

work_queue.process()