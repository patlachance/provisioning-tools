#!/usr/bin/ruby
$: << File.join(File.dirname(__FILE__), "..", "lib")

configdir = File.join(File.dirname(__FILE__), "../lib/config")
target_dir = File.join(File.dirname(__FILE__), "../target")

if Process.uid != 0
  raise 'FATAL: Process needs to run as root!'
end

require 'optparse'
require 'provision'
require 'provision/workqueue'

template = nil
hostname = nil

@option_parser = OptionParser.new do|opts|
  opts.banner =
  "Usage: provision --template ubuntuprecise --hostname mymachine"
  opts.on("-t","--template TEMPLATE", "specify the template to use") do |template_p|
    template = template_p
  end
  opts.on("-h","--hostname HOSTNAME", "specify the template to use") do |hostname_p|
    hostname = hostname_p
  end
end
@option_parser.parse!

if (template ==nil || hostname == nil)
  print  @option_parser.help()
  exit
end

#Dir.chdir(target_dir)
workqueue = Provision::WorkQueue.new(:provisioning_service => Provision.create_provisioning_service())


10.times {|i|
  workqueue.add({:hostname=>"hostname_#{i}", :template=>template})
}
workqueue.process()
