#!/usr/bin/env ruby

$: << File.join(File.dirname(__FILE__), "..", "lib")

require 'provision'

class CLI
  def initialize
    f = Provision::Factory.new
    @ns = f.numbering_service
    @name = ARGV.shift
    raise("No name given to allocate") unless @name
  end

  def get_spec
    md = /(\w+)\.(?:(\w+)\.)?(\w+)\.net\.local$/.match(@name)
    if !md
      raise("Cannot understand that name! Must be xxxx.yyy.zz.net.local")
    end
    hostname = md.to_a[1]
    network = md.to_a[2].nil? ? 'prod' : md.to_a[2]
    fabric = md.to_a[3]

    Provision::Core::MachineSpec.new(
      :hostname => hostname,
      :domain => "#{fabric}.net.local",
      :networks => [network.to_sym],
      :qualified_hostnames => {
        network.to_sym => @name
    })
  end

  def allocate 
    s = get_spec
    puts @ns.allocate_ips_for(s)[s.networks[0].to_sym][:address].to_s
  end

  def deallocate
    s = get_spec
    res = @ns.remove_ips_for(s)
    if res[s.networks[0].to_sym] && res[s.networks[0].to_sym][:address]
      puts "Removed"
    else
      puts "Did not exist"
    end
  end
end

c = CLI.new
if File.basename($0) == 'allocate_dns'
  c.allocate
else
  c.deallocate
end
