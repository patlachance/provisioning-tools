#! /usr/bin/env ruby

$: << File.join(File.dirname(__FILE__), "..", "lib")

require 'provision'

class CLI
  def initialize
    f = Provision::Factory.new
    @ns = f.numbering_service
    @name = ARGV.shift
    raise("No name given to allocate") unless @name
  end

  def get_spec
    _, hostname, network, fabric = /(\w+)\.(?:(\w+)\.)?(\w+)\.net\.local$/.match(@name).to_a
    raise("Cannot understand the name '#{@name}'! Must be xxxx.yyy.zz.net.local") unless _

    network ||= 'prod'

    Provision::Core::MachineSpec.new(
      :hostname => hostname,
      :domain => "#{fabric}.net.local",
      :networks => [network.to_sym],
      :qualified_hostnames => {
        network.to_sym => @name
      }
    )
  end

  def invoke(selector)
    s = get_spec
    res = @ns.send(selector, s)
    network = s.networks[0].to_sym
    res.fetch(network, {})[:address] || "<did not exist>"
  end
  
  def allocate
    invoke(:allocate_ips_for)
  end

  def deallocate
    invoke(:remove_ips_for)
  end
end

c = CLI.new
if File.basename($0) == 'allocate_dns'
  puts c.allocate
else
  puts c.deallocate
end
