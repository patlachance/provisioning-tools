#! /usr/bin/env ruby

$: << File.join(File.dirname(__FILE__), "..", "lib")

require 'provision'

class CLI
  def initialize
    f = Provision::Factory.new
    @ns = f.numbering_service
    @name = ARGV.shift
    raise("No name given to allocate") unless @name
  end

  def get_spec
    Provision::Core::MachineSpec.spec_for_name(@name)
  end

  def invoke(selector)
    s = get_spec
    res = @ns.send(selector, s)
    network = s.networks[0].to_sym
    res.fetch(network, {})[:address] || "<did not exist>"
  end
  
  def allocate
    invoke(:allocate_ips_for)
  end

  def deallocate
    invoke(:remove_ips_for)
  end
end

c = CLI.new
if File.basename($0) == 'allocate_dns'
  puts c.allocate
else
  puts c.deallocate
end
